import requests
import json
import os
import re
from datetime import datetime
from typing import Dict, List, Optional, Tuple

# ---------- ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® ----------
HOME_API_URL = "https://www.btvlive.gov.bd/api/home"
# ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ userId API-‡¶∞ URL ‡¶™‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡ßç‡¶®
USERID_API_PATTERN = "https://www.btvlive.gov.bd/_next/data/wr5BMimBGS-yN5Rc2tmam/channel/{urlname}.json?id={urlname}"
OUTPUT_FILE = "btv_channels.m3u"
# --------------------------------

def fetch_json(url: str, timeout: int = 10) -> Optional[Dict]:
    """‡¶Ø‡ßá ‡¶ï‡ßã‡¶®‡ßã URL ‡¶•‡ßá‡¶ï‡ßá JSON ‡¶°‡ßá‡¶ü‡¶æ fetch ‡¶ï‡¶∞‡ßá"""
    try:
        print(f"üì° Fetching: {url}")
        response = requests.get(url, timeout=timeout)
        response.raise_for_status()
        return response.json()
    except requests.exceptions.RequestException as e:
        print(f"‚ùå Error fetching {url}: {e}")
        return None

def get_channels_from_home_api() -> Optional[List[Dict]]:
    """‡¶π‡ßã‡¶Æ API ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶¨ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶¨‡ßá‡¶∏‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø (identifier, urlname, poster) ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá"""
    data = fetch_json(HOME_API_URL)
    if not data:
        return None
    
    # ‡¶π‡ßã‡¶Æ API-‡¶§‡ßá channel_list-‡¶è ‡¶∏‡¶¨ ‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤‡¶∏ ‡¶Ü‡¶õ‡ßá
    channels = data.get('channel_list', [])
    if not channels:
        print("‚ùå No channels found in home API response")
        return None
    
    print(f"‚úÖ Found {len(channels)} channels in home API")
    return channels

def get_user_id_from_channel_api(urlname: str) -> Tuple[Optional[str], Optional[str]]:
    """‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ API ‡¶•‡ßá‡¶ï‡ßá userId ‡¶è‡¶¨‡¶Ç userCountry ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßá"""
    # URL ‡¶§‡ßà‡¶∞‡¶ø
    api_url = USERID_API_PATTERN.format(urlname=urlname.replace(' ', '%20'))
    
    data = fetch_json(api_url)
    if not data:
        return None, None
    
    try:
        page_props = data.get('pageProps', {})
        source_url = page_props.get('sourceURL', '')
        user_country = page_props.get('userCountry', 'BD')
        
        # sourceURL ‡¶•‡ßá‡¶ï‡ßá userId ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ (‡¶™‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡ßç‡¶®: .../{userId}/index.m3u8)
        # URL ‡¶è‡¶∞ ‡¶∂‡ßá‡¶∑ ‡¶Ö‡¶Ç‡¶∂‡¶ü‡¶ø userId
        match = re.search(r'/([^/]+)/index\.m3u8$', source_url)
        user_id = match.group(1) if match else None
        
        if user_id:
            print(f"  ‚úì {urlname}: userId={user_id}, country={user_country}")
            return user_id, user_country
        else:
            print(f"  ‚ö†Ô∏è {urlname}: Could not extract userId from sourceURL")
            return None, None
            
    except Exception as e:
        print(f"  ‚ùå Error parsing {urlname} API: {e}")
        return None, None

def generate_m3u_content(channels: List[Dict]) -> str:
    """‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶è‡¶ï‡¶§‡ßç‡¶∞‡¶ø‡¶§ ‡¶ï‡¶∞‡ßá M3U ‡¶´‡¶æ‡¶á‡¶≤ ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶ï‡¶∞‡ßá"""
    
    content = "#EXTM3U\n"
    content += f"#PLAYLIST: Bangladesh Television Channels (Updated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')})\n"
    content += "#STATUS: Active\n"
    content += "#LANGUAGE: bn\n\n"
    
    success_count = 0
    failed_channels = []
    
    for channel in channels:
        channel_name = channel.get('channel_name', 'Unknown')
        urlname = channel.get('urlname', '')
        identifier = channel.get('identifier', '')
        poster = channel.get('poster', '')
        
        if not urlname or not identifier:
            print(f"‚ö†Ô∏è Skipping {channel_name}: Missing urlname or identifier")
            failed_channels.append(channel_name)
            continue
        
        # userId ‡¶è‡¶¨‡¶Ç userCountry ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ API ‡¶ï‡¶≤
        user_id, user_country = get_user_id_from_channel_api(urlname)
        
        # ‡¶Ø‡¶¶‡¶ø userId ‡¶®‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º, ‡¶§‡¶æ‡¶π‡¶≤‡ßá identifier ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
        if not user_id:
            print(f"‚ö†Ô∏è Using identifier as userId for {channel_name}")
            user_id = identifier
            user_country = "BD"  # ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶¶‡ßá‡¶∂
        
        # ‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø‡¶Æ URL ‡¶§‡ßà‡¶∞‡¶ø
        stream_url = f"https://www.btvlive.gov.bd/live/{identifier}/{user_country}/{user_id}/index.m3u8"
        
        # EXTINF ‡¶≤‡¶æ‡¶á‡¶® - ‡¶è‡¶ñ‡¶® poster URL ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá
        content += f"#EXTINF:-1 tvg-id=\"{identifier}\" tvg-name=\"{channel_name}\" tvg-logo=\"{poster}\" tvg-country=\"BD\" group-title=\"Bangladesh TV\", {channel_name}\n"
        content += f"{stream_url}\n\n"
        
        success_count += 1
        print(f"  ‚úÖ Generated: {channel_name}")
    
    # ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂
    content += f"# Total channels: {success_count}\n"
    content += f"# Generated by: BTV M3U Updater\n"
    
    print(f"\nüìä Summary: {success_count} channels successful, {len(failed_channels)} failed")
    if failed_channels:
        print(f"   Failed: {', '.join(failed_channels)}")
    
    return content

def main():
    print("=" * 70)
    print(f"üöÄ BTV M3U Playlist Generator - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 70)
    
    # ‡¶ß‡¶æ‡¶™ ‡ßß: ‡¶π‡ßã‡¶Æ API ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶¨ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶¨‡ßá‡¶∏‡¶ø‡¶ï ‡¶§‡¶•‡ßç‡¶Ø ‡¶®‡¶ø‡¶®
    print("\nüì• Step 1: Fetching channel list from home API...")
    channels = get_channels_from_home_api()
    if not channels:
        print("‚ùå Failed to get channel list. Exiting.")
        raise SystemExit(1)
    
    # ‡¶ß‡¶æ‡¶™ ‡ß®: ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø userId ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç M3U ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
    print("\nüîç Step 2: Fetching userId for each channel...")
    m3u_content = generate_m3u_content(channels)
    
    # ‡¶ß‡¶æ‡¶™ ‡ß©: ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
    with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
        f.write(m3u_content)
    
    # ‡¶ß‡¶æ‡¶™ ‡ß™: ‡¶´‡¶æ‡¶á‡¶≤ ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶®
    with open(OUTPUT_FILE, 'r', encoding='utf-8') as f:
        lines = f.readlines()
        channel_lines = [l for l in lines if l.startswith('#EXTINF')]
    
    print("\n" + "=" * 70)
    print(f"‚úÖ SUCCESS! M3U file updated: {OUTPUT_FILE}")
    print(f"üìä Total channels in playlist: {len(channel_lines)}")
    print(f"üìç File location: {os.path.abspath(OUTPUT_FILE)}")
    print("=" * 70)

if __name__ == "__main__":
    main()
